---
title: "Extracting model results for thesis"
author: "Vera Vinken"
date: "`r Sys.Date()`"
output: html_document
---
  
 

```{r packages}

# Load packages 
  library(ggplot2)
   library(gridExtra)       # grids of ggplots 
  library('parallel')       # for parallel computing
  library('doParallel')     # As above 
  library(dplyr)            # merging dataframes, using mutate etc. 
  library(purrr)            # To use the dataframe mapping functions 
  library(truncnorm)        # creating normal distributions 
  library(data.table)
  library(foreach)
  library(doParallel)
  library(ggpubr)             # To arrange plots 
  library(gridExtra)          # for grid.arrange 
  library(pracma)
  library(stringr)
  library(plotly)
  library(hrbrthemes)
  library(tibble)
  library(here)
  library(Hmisc)

```

## Background 
With this script, I want to be able to input which models to run and what type of output I want. The rest should be automated and pull from the sorucefiles that I have built my models from. Ideally, I want this to be the file that Tom can use in future, zipped up with all the dependencies so it is very easy to extract data. 


## Set working directories & Load sourcefiles 
If this is running from the shared Rproject, this should all be automated. 
```{r set wd and load sourcefiles, include=TRUE, message=FALSE, echo=F, warning=FALSE}
# Set directories 
  # # Where are the sourcefiles located? 
  sourcefile_wd<-i_am("Run_models_thesis.Rmd")
  sourcefile_wd<-here()
  # # Specify the parent folder where you want to save results 
  # #parent_saving_wd<-"C:/Users/c0070955/OneDrive - Newcastle University/1-PHD-project/Modelling/R/Model_output/Post_param_results_October23" 

# Load the sourcefiles 
  setwd(sourcefile_wd)
  source('MOD_1_FuncSource.R')
  source('ModelSource.R')

```

## Compare branching performance 

Can only be done for the x1 and x2 models, as they ran through the branches fully. 

```{r compare branching performance}
setwd(sourcefile_wd)
opt_res<-read.csv("branch_comparison_all.csv")

opt_res<-pivot_longer(opt_res, c(b4, b6, b8, b10, b12))
opt_res$name <- factor(opt_res$name, levels = c("b4", "b6", "b8", "b10", "b12"), ordered = TRUE)
opt_res$Model.num<-factor(opt_res$Model.num, levels = c("11", "21", "31", "41", "51", "61","12", "22", "32", "42", "52", "62", 
                                                        "13", "23", "33", "43", "53", "63","14", "24", "34", "44", "54", "64"))
opt_res$Model.type<-factor(opt_res$Model.type, levels = c("SC - H", "FR - H ", "FCR - H", "FR -FCR - H", "SC - FR - H", "SC - FCR - H ",
                                                          "SC - NH", "FR - NH ", "FCR - NH", "FR -FCR - NH", "SC - FR - NH", "SC - FCR - NH ", 
                                                          "SC-DH1", "FR-DH1", "FCR-DH1", "FR-FCR-DH1", "SC-FR-DH1", "SC-FCR-DH1", 
                                                          "SC-DH2", "FR-DH2", "FCR-DH2", "FR-FCR-DH2", "SC-FR-DH2", "SC-FCR-DH2"))
opt_res$days<-(opt_res$value/72)
ggplot(opt_res, aes(x = Model.num, y = days, fill = name)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Model Type", y = "Mean halflife survival (days)", fill = "Branch") +
  vera_theme(bg = "white")


```



## Comparing model results 


```{r set which model to run, include=TRUE, warning=FALSE,echo=F, message=FALSE}
models<-c("11", "21", "31", "41", "51", "61", 
          "12", "22", "32", "42", "52", "62", 
          "131", "231", "331", "431", "531", "631", 
          "132", "232", "332", "432", "532", "632") # Keep this as is (unless runnig models from scratch)
int_var<-"stom_con"  # This is hte variable you can chagne in order to inspect specific variables! 

# If you are using the previously generated data, do not change these the code will use teh default settings 
num_birds<-1000
daylight_h<-8
days<-30 
```

## Loop through models 

At the moment (10/10/2024) my decision is to use the branch 6 outcomes. In my results section I'll clarify why I do so. 
5 decimals were used. 

Run all models for set input parameters, across all environments. Save results in list. 

```{r loop through models to run}
for (i in 1:length(models)){
  
  if (i==1){
    # create a list for the output 
    env_func_out_list<-list()
  }
  
  # Model 11 
  if (models[i]==11){
    # Code that runs 11
    env_func_1_1_par(days = days, 
                     N= num_birds, 
                     th_forage_sc = 0.00208, 
                     daylight_h = daylight_h, 
                     modelType = 11, 
                     sourcefile_wd = sourcefile_wd) 
    
  }else if (models[i]==12){
    # Code that runs 12 
    env_func_1_2_par(days = days, 
                     N= num_birds, 
                     th_forage_sc1 = 0.02708, 
                     th_forage_sc2 = 0.08125, 
                     daylight_h = daylight_h, 
                     modelType = 12, 
                     sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==131){
    # Code that runs 131 
      env_func_1_3_1_par(days = days, 
                         N= num_birds, 
                         th_forage_sc1 = 0.03125, 
                         th_forage_sc2 = 0.08958, 
                         th_forage_sc3 = 0.29375, 
                         daylight_h = daylight_h, 
                         modelType = 131, 
                         sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==132){
    # Code that runs 132
        env_func_1_3_2_par(days = days, 
                           N= num_birds, 
                           th_forage_sc1 =0.02708, 
                           th_forage_sc2 =0.13125, 
                           th_forage_sc3 =0.13542, 
                           daylight_h = daylight_h, 
                           modelType = 132, 
                           sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==21){
    # Code that runs 21 
    env_func_2_1_par(days = days, 
                     N= num_birds, 
                     th_forage_fr = 1.60417, 
                     daylight_h = daylight_h, 
                     modelType = 21, 
                     sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==22){
    # Code that runs 22 
    env_func_2_2_par(days = days, 
                     N= num_birds, 
                     th_forage_fr1 = 1.02083, 
                     th_forage_fr2 = 1.43750, 
                     daylight_h = daylight_h, 
                     modelType = 22, 
                     sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==231){
    # Code that runs 231 
      env_func_2_3_1_par(days = days, 
                         N= num_birds, 
                         th_forage_fr1 = 0.39583, 
                         th_forage_fr2 = 1.39583 , 
                         th_forage_fr3 = 2.93750, 
                         daylight_h = daylight_h, 
                         modelType = 231, 
                         sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==232){
    # Code that runs 232 
    env_func_2_3_2_par(days = days, 
                       N= num_birds, 
                       th_forage_fr1 = 0.39583, 
                       th_forage_fr2 = 2.22917, 
                       th_forage_fr3 = 3.81250, 
                       daylight_h = daylight_h, 
                       modelType = 232, 
                       sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==31){
    # Code that runs 31 
    env_func_3_1_par(days = days, 
                     N= num_birds, 
                     th_forage_flr = 0.23125, 
                     daylight_h = daylight_h, 
                     modelType = 31, 
                     sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==32){
    # Code that runs 32 
    env_func_3_2_par(days = days, 
                     N= num_birds, 
                     th_forage_flr1 = -0.06875, 
                     th_forage_flr2 = 0.11875, 
                     daylight_h = daylight_h, 
                     modelType = 32, 
                     sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==331){
    # Code that runs 331 
    env_func_3_3_1_par(days = days, 
                       N= num_birds, 
                       th_forage_flr1 = -0.13125, 
                       th_forage_flr2 = 0.21875, 
                       th_forage_flr3 = 0.41875, 
                       daylight_h = daylight_h, 
                       modelType = 331, 
                       sourcefile_wd = sourcefile_wd)
    
  } else if (models[i]==332){
    env_func_3_3_2_par(days = days, 
                       N= num_birds, 
                       th_forage_flr1 = -0.11875, 
                       th_forage_flr2 = 0.25625, 
                       th_forage_flr3 = 0.49375, 
                       daylight_h = 8, 
                       modelType = 332, 
                       sourcefile_wd = sourcefile_wd)
    
  }else if (models[i]==41){
    env_func_4_1_par(days = days, 
                     N = num_birds,
                     th_forage_fr= 1.52083, 
                     th_forage_flr= -0.00625, 
                     daylight_h = daylight_h, 
                     modelType = 41, 
                     sourcefile_wd = sourcefile_wd)
    
  } else if (models[i] == 51){
        env_func_5_1_par(days = days, 
                     N = num_birds,
                     th_forage_sc= 0.03125, 
                     th_forage_fr = 0.31250, 
                     daylight_h = daylight_h, 
                     modelType = 51, 
                     sourcefile_wd = sourcefile_wd)
    
  }else if (models[i] == 61){
        env_func_6_1_par(days = days, 
                     N = num_birds,
                     th_forage_sc= 0.01458, 
                     th_forage_flr = -0.58125, 
                     daylight_h = daylight_h, 
                     modelType = 61, 
                     sourcefile_wd = sourcefile_wd)
    
  } else if (models[i] == 42){
    env_func_4_2_par(days = days, 
                     N = num_birds, 
                     th_forage_fr1 = 1.31250, 
                     th_forage_fr2 = 1.354167, 
                     th_forage_flr1 = -0.03125, 
                     th_forage_flr2 = 0.00625, 
                     daylight_h = daylight_h, 
                     modelType = 42, 
                     sourcefile_wd = sourcefile_wd)
    
  }else if (models[i] == 52){
    env_func_5_2_par(days = days, 
                     N = num_birds, 
                     th_forage_sc1 = 0.06458, 
                     th_forage_sc2 = 0.1145833, 
                     th_forage_fr1 = 1.3125, 
                     th_forage_fr2 = 1.39583, 
                     daylight_h = daylight_h, 
                     modelType = 52, 
                     sourcefile_wd = sourcefile_wd)
    
  }else if (models[i] == 62){
    env_func_6_2_par(days = days, 
                     N = num_birds, 
                     th_forage_sc1 = 0.05208, 
                     th_forage_sc2 = 0.09792, 
                     th_forage_flr1 = -0.20625, 
                     th_forage_flr2 = -0.18125, 
                     daylight_h = daylight_h, 
                     modelType = 62, 
                     sourcefile_wd = sourcefile_wd)
    
  }else if (models[i]== 431){
    env_func_4_3_1_par(days = days, 
                       N = num_birds, 
                       th_forage_fr1 =  0.68750 , 
                       th_forage_fr2 = 1.35417,
                       th_forage_fr3 = 3.14585, 
                       th_forage_flr1 = -0.09375, 
                       th_forage_flr2 = 0.21875, 
                       th_forage_flr3 = 0.46875, 
                       daylight_h = daylight_h, 
                       modelType = 431, 
                       sourcefile_wd = sourcefile_wd)
    
  }else if (models[i]== 531){
    env_func_5_3_1_par(days = days, 
                       N = num_birds, 
                       th_forage_sc1 = 0.00625, 
                       th_forage_sc2 = 0.08542,
                       th_forage_sc3 = 0.31877, 
                       th_forage_fr1 = 0.7291667, 
                       th_forage_fr2 = 1.562507, 
                       th_forage_fr3 = 2.104173, 
                       daylight_h = daylight_h, 
                       modelType = 531, 
                       sourcefile_wd = sourcefile_wd)
    
  }else if (models[i]== 631){
    env_func_6_3_1_par(days = days, 
                       N = num_birds, 
                       th_forage_sc1 = 0.05626, 
                       th_forage_sc2 = 0.07708,
                       th_forage_sc3 = 0.3146, 
                       th_forage_flr1 = 0.04375, 
                       th_forage_flr2 = 0.24375, 
                       th_forage_flr3 = 0.54375, 
                       daylight_h = daylight_h, 
                       modelType = 631, 
                       sourcefile_wd = sourcefile_wd)
    
  }else if (models[i]== 432){
    env_func_4_3_2_par(days = days, 
                       N = num_birds, 
                       th_forage_fr1 =  0.68750, 
                       th_forage_fr2 = 2.35418,
                       th_forage_fr3 = 3.43751, 
                       th_forage_flr1 = -0.04375, 
                       th_forage_flr2 = 0.28125, 
                       th_forage_flr3 = 0.41875, 
                       daylight_h = daylight_h, 
                       modelType = 432, 
                       sourcefile_wd = sourcefile_wd)
    
  }else if (models[i]== 532){
    env_func_5_3_2_par(days = days, 
                       N = num_birds, 
                       th_forage_sc1 =0.00625, 
                       th_forage_sc2 = 0.09375,
                       th_forage_sc3 =0.27709 , 
                       th_forage_fr1 = 0.89584, 
                       th_forage_fr2 = 2.52085, 
                       th_forage_fr3 = 3.06252, 
                       daylight_h = daylight_h, 
                       modelType = 532, 
                       sourcefile_wd = sourcefile_wd)
    
  }else if (models[i]== 632){
    env_func_6_3_2_par(days = days, 
                       N = num_birds, 
                       th_forage_sc1 = 0.11459, 
                       th_forage_sc2 =0.22293 ,
                       th_forage_sc3 = 0.33543, 
                       th_forage_flr1 = 0.19375, 
                       th_forage_flr2 = 0.23125, 
                       th_forage_flr3 = 0.46875, 
                       daylight_h = daylight_h, 
                       modelType = 632, 
                       sourcefile_wd = sourcefile_wd)
  }
  
    # wrap up 
  output_env_func[[3]]<-models[i]
  
  # Now save the result of this iteration in a meaningful way 
  env_func_out_list[[i]]<-output_env_func
  
  print(paste("model done=", models[i]))
  
}

# make sure that the lists inside the list have the right name 
names(env_func_out_list)<-models
# setwd(sourcefile_wd)
# save(env_func_out_list, file="results.Rda")

```

## Merge the dataframes 

```{r merge model dataframes}
# Assuming your outer list is named 'model_list'
# The names of the list items are 11, 21, 31, etc.

# Iterate over the outer list
for (i in seq_along(env_func_out_list)) {
  # Get the current name (11, 21, 31, etc.)
  model_name <- names(env_func_out_list)[i]
  
  # Extract the list of 12 dataframes (second item in each sublist)
  df_list <- env_func_out_list[[i]][[2]]
  
  # Iterate over each dataframe in this list
  for (j in seq_along(df_list)) {
    env<-j
    # Add the "model_type" column to each dataframe
    df_list[[j]]$model_type <- model_name
    df_list[[j]]$env<-env
  }
  
  # Update the list with the modified list of dataframes
  env_func_out_list[[i]][[2]] <- df_list
}

# Initialize an empty list to hold all dataframes
all_dfs<- list()

# Iterate over the outer list
for (i in seq_along(env_func_out_list)) {
  # Extract the list of 12 dataframes (second item in each sublist)
  df_list <- env_func_out_list[[i]][[2]]
  
  # Combine the dataframes in the current list and store them
  all_dfs <- c(all_dfs, df_list)
}

# Combine all dataframes into one dataframe
df<- do.call(rbind, all_dfs)

# clean up 
rm(all_dfs)
rm(df_list)
rm(env_func_out_list)
rm(level2)
rm(output_env_func)
rm(t_HL_list)


# add a chapter label to the df 
df<-df%>%
  mutate(chapter = case_when(
    model_type == "11" ~ 5, 
    model_type == "12" ~ 5, 
    model_type == "131" ~ 5, 
    model_type == "132" ~ 5, 
    model_type == "21" ~ 6, 
    model_type == "22" ~ 6, 
    model_type == "231" ~ 6, 
    model_type == "231" ~ 6, 
    model_type == "31" ~ 6, 
    model_type == "32" ~ 6, 
    model_type == "331" ~ 6, 
    model_type == "332" ~ 6, 
    model_type == "41" ~ 6, 
    model_type == "42" ~ 6, 
    model_type == "431" ~ 6, 
    model_type == "432" ~ 6,
    model_type == "51" ~ 7, 
    model_type == "52" ~ 7, 
    model_type == "531" ~ 7, 
    model_type == "532" ~ 7, 
    model_type == "61" ~ 7, 
    model_type == "62" ~ 7, 
    model_type == "631" ~ 7, 
    model_type == "632" ~ 7, 
  ))%>%
        mutate(temp=if_else((.$env=="1"|.$env=="3"|.$env=="5"|.$env=="7"|.$env=="9"|.$env=="11"), "low", "high"))%>%
        mutate(food_ab=case_when(
          env<5 ~ "low", 
          env>4 & env<9 ~ "medium", 
          env>8 ~ "high"
        ))%>%
        mutate(food_pred=if_else((.$env=="1"|.$env=="2"|.$env=="5"|.$env=="6"|.$env=="9"|.$env=="10"), "Poisson", "Bonanza"))%>%
  mutate(timestep_within_day=timestep%%72)

df$food_pred <- factor(df$food_pred, levels = c( "Poisson", "Bonanza"), ordered = TRUE)

save(df, file = "df_all_models_standard.Rda")
```


## Chapter 4 

### Survival chapter 4

```{r graphs chapter survival 4}
# set the colours
# I need 4 colours for the 4 models 

#ch4_col<-c("#AA4499", "#DDCC77", "#44AA99", "#332288")
ch4_col<-c("#FFBD30", "#CA5D05", "#2E5F14", "#8DA27F")

ggplot(df%>%filter(id == "alive"), aes(y= value, x = timestep, col = model_type))+
  geom_line()+
  facet_wrap(~env, ncol = 2)+
  vera_theme(bg = "white")



## survival across environment 5 and 6 
p<-ggplot(df %>% filter(id == "alive", chapter == 5, (env == 8 | env == 6)), 
       aes(y = value, x = timestep, col = model_type)) +
  geom_line(size = 1) +
  facet_wrap(~food_pred, ncol = 2) +
  ylim(0, 1) +
  ylab("Proportion of birds alive") +
  xlab("Days") +  # Change x-axis label to "Days"
  scale_x_continuous(breaks = seq(0, 2160, by = 360),   # Set breaks every 360 timesteps (5 days)
                     labels = seq(0, 30, by = 5)) +     # Label every 5 days
  vera_theme(bg = "white") +
  scale_color_manual(values = ch4_col, 
                     name = "Hoarding type", 
                     labels = c("Non hoarding", "Leftover hoarding", "Direct hoarding Htop", "Direct hoarding Rtop"))


# Save the plot with specified size and resolution
ggsave("standardized_plot_surv.png", plot = p, width = 7, height = 3, dpi = 500)  # Specify the size in inches and resolution

```


###  chapter 4 physiology 
```{r chapter 4 physiology }
# Define a named vector for the new labels
id_labels <- c("stom_con" = "SC", "fat_res" = "FR", "fat_loss_r" = "FCR")

# Ensure 'id' is a factor with the desired order
df$id <- factor(df$id, levels = c("stom_con", "fat_res", "fat_loss_r", "mass", "alive", "sleep", "rest", "forage","eat", "eat_hoard", "dir_hoard", "retrieve","find_food", "predation", "caches", "cache_decay", "temp"))


p<-ggplot(df %>% filter((id == "fat_res" | id == "stom_con" | id == "fat_loss_r"), (model_type == "11" | model_type == "12" | model_type =="131" |model_type == "132"), (env == 8 | env == 6)), 
       aes(y = value, x = timestep, col = model_type)) +
  geom_line(size = 0.75) +
  facet_grid(vars(id), vars(food_pred), scales = "free_y", labeller = labeller(id = id_labels)) +  # Rename facet labels
  xlab("Days") +  # Change x-axis label to "Days"
  ylab("Value")+
  scale_x_continuous(breaks = seq(0, 2160, by = 360),   # Set breaks every 360 timesteps (5 days)
                     labels = seq(0, 30, by = 5)) +     # Label every 5 days
  vera_theme(bg = "white") +
  scale_color_manual(values = ch4_col, 
                     name = "", 
                     labels = c("Non hoarding", "Leftover hoarding", "Direct hoarding Htop", "Direct hoarding Rtop")) +
  theme(legend.position = "bottom")  # Move legend to the bottom

# Save the plot with specified size and resolution
ggsave("standardized_plot_psych.png", plot = p, width = 7, height = 5, dpi = 500)  # Specify the size in inches and resolution




# Now I want to average that across the days 

df_psych_sum<-df%>%
  group_by(id, env, timestep_within_day, model_type, food_pred)%>%
  summarise(mean_value = mean(value))



p<-ggplot(df_psych_sum %>% filter((id == "fat_res" | id == "stom_con" | id == "fat_loss_r"), (model_type == "11" | model_type == "12" | model_type =="131" |model_type == "132"), (env == 8 | env == 6), timestep_within_day<=23), 
       aes(y = mean_value, x = timestep_within_day, col = model_type)) +
  geom_line(size = 0.75) +
  facet_grid(vars(id), vars(food_pred), scales = "free_y", labeller = labeller(id = id_labels)) +  # Rename facet labels
  xlab("Timestep in day") +  # Change x-axis label to "Days"
  ylab("Value")+
  scale_x_continuous(breaks = seq(0, 23, by = 3),   # Set breaks every 360 timesteps (5 days)
                     labels = seq(1, 8, by = 1)) +     # Label every 5 days
  vera_theme(bg = "white") +
  scale_color_manual(values = ch4_col, 
                     name = "", 
                     labels = c("Non hoarding", "Leftover hoarding", "Direct hoarding Htop", "Direct hoarding Rtop")) +
  theme(legend.position = "bottom")#+  # Move legend to the bottom
  #xlim(0, 24)

p# Save the plot with specified size and resolution
ggsave("standardized_plot_psych.png", plot = p, width = 7, height = 5, dpi = 500)  # Specify the size in inches and resolution


```



###  chapter 4 Behaviour

```{r chapter 4 behaviour }


p<-ggplot(df %>% filter((id == "rest" | id == "eat" | id == "eat_hoard" |id == "dir_hoard" |id =="retrieve"), (model_type == "11" | model_type == "12" | model_type =="131" |model_type == "132"), (env == 8 | env == 6)), 
       aes(y = value, x = timestep, col = model_type)) +
  geom_line(size = 0.75) +
  facet_grid(vars(id), vars(food_pred), scales = "free_y", labeller = labeller(id = id_labels)) +  # Rename facet labels
  xlab("Days") +  # Change x-axis label to "Days"
  ylab("Value")+
  scale_x_continuous(breaks = seq(0, 2160, by = 360),   # Set breaks every 360 timesteps (5 days)
                     labels = seq(0, 30, by = 5)) +     # Label every 5 days
  vera_theme(bg = "white") +
  scale_color_manual(values = ch4_col, 
                     name = "", 
                     labels = c("Non hoarding", "Leftover hoarding", "Direct hoarding Htop", "Direct hoarding Rtop")) +
  theme(legend.position = "bottom")  # Move legend to the bottom

# Save the plot with specified size and resolution
ggsave("standardized_plot_beh.png", plot = p, width = 7, height = 5, dpi = 500)  # Specify the size in inches and resolution




# Now I want to average that across the days 

df_psych_sum<-df%>%
  group_by(id, env, timestep_within_day, model_type, food_pred)%>%
  summarise(mean_value = mean(value))



p<-ggplot(df_psych_sum %>% filter((id == "fat_res" | id == "stom_con" | id == "fat_loss_r"), (model_type == "11" | model_type == "12" | model_type =="131" |model_type == "132"), (env == 8 | env == 6), timestep_within_day<=23), 
       aes(y = mean_value, x = timestep_within_day, col = model_type)) +
  geom_line(size = 0.75) +
  facet_grid(vars(id), vars(food_pred), scales = "free_y", labeller = labeller(id = id_labels)) +  # Rename facet labels
  xlab("Timestep in day") +  # Change x-axis label to "Days"
  ylab("Value")+
  scale_x_continuous(breaks = seq(0, 23, by = 3),   # Set breaks every 360 timesteps (5 days)
                     labels = seq(1, 8, by = 1)) +     # Label every 5 days
  vera_theme(bg = "white") +
  scale_color_manual(values = ch4_col, 
                     name = "", 
                     labels = c("Non hoarding", "Leftover hoarding", "Direct hoarding Htop", "Direct hoarding Rtop")) +
  theme(legend.position = "bottom")#+  # Move legend to the bottom
  #xlim(0, 24)

p# Save the plot with specified size and resolution
ggsave("standardized_plot_psych.png", plot = p, width = 7, height = 5, dpi = 500)  # Specify the size in inches and resolution


```































### Survival across the selected models 
The following graph shows how the different models survive across the environments. Survival is hte proportion of birds alive at any given timestep. 

#### Mean across all environments: 
```{r visualise  mean data wrange, include=T, message=F, warning=F, echo=F, fig.width=10, fig.height=5}

focus<-"all_colours"
 # loop through each of the models 
  for (i in 1:length(models)){
    if (i==1){
      output_per_model_list<-list()
    }
    # Set the current model from the env_func_out_list (input to this function)
      cur_out<-env_func_out_list[[models[i]]]
    
      # create empty list
      cur_mod_df<-list()
      
      # Concatenate the dataframes in the list 
      for (df in cur_out[[2]]){
        cur_mod_df<-rbind(cur_mod_df, df)
      }
      # summarize them by variable and timestep 
      cur_mod_df_sum<-cur_mod_df%>%
        group_by(timestep, id)%>%
        summarise(mean_val = mean(value, na.rm=T))%>%
        mutate(mod_id=models[i])%>%
        mutate(line_id=lim_col_df[lim_col_df$all_models==models[i], 5])%>%
        mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))

      output_per_model_list[[i]]<-cur_mod_df_sum
  }
  
  mean_var_per_model_total<-bind_rows(output_per_model_list)
  
  if(focus=="colours_hoard_foc"){
    colours<-lim_col_df$colours_hoard_foc
  }else if(focus=="colours_prox_foc"){
    colours<-lim_col_df$colours_prox_foc
  }else if(focus=="all_colours"){
    colours<-lim_col_df$all_colours
  }
  
  
```

```{r visualise  mean graph, include=T, message=F, warning=F, echo=F, fig.width=10, fig.height=5}

  plot_var<-ggplot(mean_var_per_model_total[mean_var_per_model_total$id=="alive",], aes(x=timestep, y=mean_val))+
    geom_line(aes( col=leg_name, linetype=line_id))+
    #ggtitle(label=paste("Survival  - Average across 12 env. " ))+
    theme(plot.title=element_text(face='bold'), 
          axis.title.x = element_text(face='bold' ), 
          axis.title.y=element_text(face='bold'), 
          strip.text=element_text(), 
          legend.text=element_text())+
    ylim(c(0,1))+
    scale_color_manual(values=colours)+
    ylab(label="Proportion birds alive")
 
  plot_var<-ggplotly(plot_var)
  plot_var%>% layout(legend = list(title=list(text='<b>Model ID<b>')))

```

#### Split by enevironment 
```{r visualise the outcome survival data wrangle  , include=T, message=F, warning=F, echo=F, fig.width=10, fig.height=13}
# legend<-c("1.1: SC-Non H", "1.2: SC-left H", "1.3.1: SC-Dir H-Htop", "1.3.2: SC-Dir H-Rtop",
#                             "2.1: FR-Non H", "2.2: FR-left H", "2.3.1: FR-Dir H-Htop", "2.3.2: FR-Dir H-Rtop",
#                             "3.1: FCR-Non H", "3.2: FCR-left H", "3.3.1: FCR-Dir H-Htop", "3.3.2: FCR-Dir H-Rtop")
int_var<-"alive"
# First determine if you wanted the output split by environment or not 
# I think it makes sense to always print the survival (as you will alwasy be interested in this)
  # plot_env_12_comp_func(env_func_out_list = env_func_out_list, models = models, int_var = "alive", focus="all_colours")
focus="all_colours"
# Loop through the models to extract the correct variable 
  for (i in 1:length(models)){
    if (i==1){
      output_per_model_list<-list()
    }
    # Set the current model from the env_func_out_list (input to this function)
    cur_out<-env_func_out_list[[models[i]]]
    # Now subset for the variable of interest 
    cur_out_filtered<-lapply(cur_out[[2]], function(df){subset(df, id==paste(int_var))})
    # Add the environment number to the dataframes 
    for (j in 1:length(cur_out_filtered)){
      cur_out_filtered[[j]]$env_id<-j
      cur_out_filtered[[j]]$mod_id<-models[i]
      cur_out_filtered[[j]]$line_id<-lim_col_df[lim_col_df$all_models==models[i], 5]
      cur_out_filtered[[j]]<-cur_out_filtered[[j]]%>%
        mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(temp=if_else((.$env_id=="1"|.$env_id=="3"|.$env_id=="5"|.$env_id=="7"|.$env_id=="9"|.$env_id=="11"), "low", "high"))%>%
        mutate(food_ab=case_when(
          env_id<5 ~ "low", 
          env_id>4 & env_id<9 ~ "medium", 
          env_id>8 ~ "high"
        ))%>%
        mutate(food_pred=if_else((.$env_id=="1"|.$env_id=="2"|.$env_id=="5"|.$env_id=="6"|.$env_id=="9"|.$env_id=="10"), "poisson", "bonanza"))
    }
    output_per_model_list[[i]]<-cur_out_filtered
    
  }
  # for the individual dataframes 
  total_all_models_surv<-list()
  # loop through each of the models  and retrieve all 12 dataframes to put in the 'individual dataframe list' 
  for (sublist in output_per_model_list) {
    for (df in sublist) {
      total_all_models_surv <- rbind(total_all_models_surv, df)
    }
  }

  
  # Now you want to produce a grid of plots, where data is split per environment 
    # On your x-axis you want time "timestep" 
    # On you y-axis you want the value of the chosen variable 'value' 
  
  # select colours
  if(focus=="colours_hoard_foc"){
    colours<-lim_col_df$colours_hoard_foc
  }else if(focus=="colours_prox_foc"){
    colours<-lim_col_df$colours_prox_foc
  }else if(focus=="all_colours"){
    colours<-lim_col_df$all_colours
  }
  
```

```{r visualise the outcome survival graph  , include=T, message=F, warning=F, echo=F, fig.width=10, fig.height=13}

  
      plot_12<-ggplot(total_all_models_surv, aes(x=timestep, y=value))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~env_id,  nrow=6)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        labs(fill=" ")

      plot_12<-ggplotly(plot_12)
      plot_12%>% layout(legend = list(title=list(text='<b>Model ID<b>')))
      #plot_12
```

#### Effects of temperature 

```{r compare temperatures, include=T, message=F, warning=F, echo=F}

# add the temp info and regroup 
temp_average_all<-total_all_models_surv%>%
  group_by(timestep,leg_name, temp, line_id, id)%>%
  summarise(mean_val = mean(value, na.rm=T))

```


```{r compare temperatures graph , include=T, message=F, warning=F, echo=F}
facet_order<-c("low", "high")
temp_average_all$temp <- factor(temp_average_all$temp, levels = facet_order)

plot<-ggplot(temp_average_all[temp_average_all$id=="alive",], aes(x=timestep, y=mean_val))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~temp, nrow=2)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        ylab(label="Proportion of birds alive")

      plot<-ggplotly(plot)
plot %>% layout(legend=list(title=list(text='<b> Model ID</b>')))

```


#### Effects of Food abundancy 

```{r compare food abundancy, include=T, message=F, warning=F, echo=F}

# add the temp info and regroup 
food_ab_average_all<-total_all_models_surv%>%
  group_by(timestep,leg_name, food_ab, line_id)%>%
  summarise(mean_val = mean(value, na.rm=T))

```


```{r compare food abundancy graph , include=T, message=F, warning=F, echo=F}
facet_order<-c("low", "medium", "high")
food_ab_average_all$food_ab <- factor(food_ab_average_all$food_ab, levels = facet_order)

plot<-ggplot(food_ab_average_all, aes(x=timestep, y=mean_val))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~food_ab, nrow=3)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        ylab(label="Proportion of birds alive")

      plot<-ggplotly(plot)
plot %>% layout(legend=list(title=list(text='<b> Model ID</b>')))

```


#### Effects of Food predictability

```{r compare food predictability, include=T, message=F, warning=F, echo=F}

# add the temp info and regroup 
food_pred_average_all<-total_all_models_surv%>%
  group_by(timestep,leg_name, food_pred, line_id)%>%
  summarise(mean_val = mean(value, na.rm=T))

```

```{r compare food predictability  graph , include=T, message=F, warning=F, echo=F}
facet_order<-c("poisson", "bonanza")
food_pred_average_all$food_pred <- factor(food_pred_average_all$food_pred, levels = facet_order)

plot<-ggplot(food_pred_average_all, aes(x=timestep, y=mean_val))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~food_pred,nrow=2)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        ylab(label="Proportion of birds alive")

      plot<-ggplotly(plot)
plot %>% layout(legend=list(title=list(text='<b> Model ID</b>')))

```

### Energy proxies 
```{r aggregate for daily patterns, include=TRUE, message=F, warning=F, echo=F,fig.width=17, fig.height=8}
# Input here will be the env_func_out_list 

for (i in 1:length(models)){
  
  if (i==1){
    agg_list<-list()
  }
  # Select hte current list with the 12 dataframes 
  cur_mod<-env_func_out_list[[models[i]]][[2]]
  
  # Cut off the first 3 days 
  
  # add the env row 
  for (j in 1:length(cur_mod)){
    cur_mod[[j]]<-cur_mod[[j]]%>%filter(timestep>216)
    cur_mod[[j]]$env_id<-j
  }
  # bind it all together 
  cur_mod<-bind_rows(cur_mod)
  # add the timestep within day 
  cur_mod<-cur_mod%>%
    mutate(timestep_within_day=timestep%%72)
    #mutate(timestep_within_day = replace(timestep_within_day, timestep_within_day == 0, 72))
  
  # Now summarise the dataframe by timestep within day 
  agg_cur_mod<-cur_mod%>%
    group_by(id, env_id, timestep_within_day)%>%
    summarise(mean_value_day=mean(value, na.rm=T)) %>%#, 
             # mean_ts_within_day=mean(timestep_within_day, na.rm=T))%>%
    mutate(mod_id=rep(models[i]))%>%
     mutate(line_id=lim_col_df[lim_col_df$all_models==models[i], 5])
  
  # Now add to list
  agg_list[[i]]<-agg_cur_mod
}

# bind them all together in a dataframe 
agg_day_df<-bind_rows(agg_list)


# When including the 3 first days (e.g. when showing dead model examples: )

for (i in 1:length(models)){
  
  if (i==1){
    agg_list_unfilt<-list()
  }
  # Select hte current list with the 12 dataframes 
  cur_mod<-env_func_out_list[[models[i]]][[2]]
  
  # Cut off the first 3 days 
  
  # add the env row 
  for (j in 1:length(cur_mod)){
    #cur_mod[[j]]<-cur_mod[[j]]%>%filter(timestep>216)
    cur_mod[[j]]$env_id<-j
  }
  # bind it all together 
  cur_mod<-bind_rows(cur_mod)
  # add the timestep within day 
  cur_mod<-cur_mod%>%
    mutate(timestep_within_day=timestep%%72)
    #mutate(timestep_within_day = replace(timestep_within_day, timestep_within_day == 0, 72))
  
  # Now summarise the dataframe by timestep within day 
  agg_cur_mod<-cur_mod%>%
    group_by(id, env_id, timestep_within_day)%>%
    summarise(mean_value_day=mean(value, na.rm=T)) %>%#, 
             # mean_ts_within_day=mean(timestep_within_day, na.rm=T))%>%
    mutate(mod_id=rep(models[i]))%>%
     mutate(line_id=lim_col_df[lim_col_df$all_models==models[i], 5])
  
  # Now add to list
  agg_list_unfilt[[i]]<-agg_cur_mod
}

# bind them all together in a dataframe 
agg_day_df_unfilt<-bind_rows(agg_list_unfilt)


```

#### Average over all 12 environments 

```{r check mean across environment for all values, include=TRUE, message=F, warning=F, echo=F}

 # loop through each of the models 
  for (i in 1:length(models)){
    if (i==1){
      mean_vars_day_pat_list<-list()
    }
    # Set the current model from the env_func_out_list (input to this function)
      cur_out<-agg_list[[i]]
      
    # Do the transformations so we get means across all environments 
      cur_mean_out<-cur_out%>%
        group_by(id, timestep_within_day, mod_id)%>%
        summarise(mean_new=mean(mean_value_day, na.rm=T))%>%
         mutate(line_id=lim_col_df[lim_col_df$all_models==models[i], 5])%>%
      mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
         mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

    # Add to list 
      mean_vars_day_pat_list[[i]]<-cur_mean_out
  }
  
  all_vars_day_pat_tot<-bind_rows(mean_vars_day_pat_list)
  

  # unfiltered 
  
  
 # loop through each of the models 
  for (i in 1:length(models)){
    if (i==1){
      mean_vars_day_pat_list_unfilt<-list()
    }
    # Set the current model from the env_func_out_list (input to this function)
      cur_out<-agg_list_unfilt[[i]]
      
    # Do the transformations so we get means across all environments 
      cur_mean_out<-cur_out%>%
        group_by(id, timestep_within_day, mod_id)%>%
        summarise(mean_new=mean(mean_value_day, na.rm=T))%>%
         mutate(line_id=lim_col_df[lim_col_df$all_models==models[i], 5])%>%
      mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
         mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

    # Add to list 
      mean_vars_day_pat_list_unfilt[[i]]<-cur_mean_out
  }
  
  all_vars_day_pat_tot_unfilt<-bind_rows(mean_vars_day_pat_list_unfilt)
  


```

```{r plot all variables across enviornments in daily patterns, include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}

plot<-ggplot(all_vars_day_pat_tot[all_vars_day_pat_tot$id=="stom_con"|all_vars_day_pat_tot$id=="fat_res"|all_vars_day_pat_tot$id=="fat_loss_r", ], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~id, scales='free_y',nrow=6)+
        coord_cartesian(xlim=c(0, 25))+
        #ggtitle(label="Energy proxies- Daily patterns - Across all environments")+
        labs(y="SC  -  FR  -  FCR (in gram or gram/2 hours)", x="Timestep within the Day", col="Model ID")+
        theme(plot.title=element_text( face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text( face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title = element_text(face='bold'))+
  scale_color_manual(values=colours)+
  labs(fill=" ")


p<-ggplotly(plot)
p%>% layout(legend = list(title=list(text='<b>Model ID<b>')))

```


#### Stomach content 

```{r check mean across environment for all valuessss, include=TRUE, message=F, warning=F, echo=F}

 # loop through each of the models 
  for (i in 1:length(models)){
    if (i==1){
      day_pat_per_envlist<-list()
    }
    # Set the current model from the env_func_out_list (input to this function)
      cur_out<-agg_list[[i]]
      
    # Do the transformations so we get means across all environments 
      cur_mean_out<-cur_out%>%
        group_by(id, timestep_within_day, mod_id, env_id,)%>%
        summarise(mean_new=mean(mean_value_day, na.rm=T))%>%
        mutate(line_id=lim_col_df[lim_col_df$all_models==models[i], 5])%>%
      mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))
      
    # Add to list 
      day_pat_per_envlist[[i]]<-cur_mean_out
  }
  
  day_pat_per_env_df<-bind_rows(day_pat_per_envlist)
  
  
  
# unfiltered 
   # loop through each of the models 
  for (i in 1:length(models)){
    if (i==1){
      day_pat_per_envlist_unfilt<-list()
    }
    # Set the current model from the env_func_out_list (input to this function)
      cur_out<-agg_list_unfilt[[i]]
      
    # Do the transformations so we get means across all environments 
      cur_mean_out<-cur_out%>%
        group_by(id, timestep_within_day, mod_id, env_id,)%>%
        summarise(mean_new=mean(mean_value_day, na.rm=T))%>%
        mutate(line_id=lim_col_df[lim_col_df$all_models==models[i], 5])%>%
      mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))
      
    # Add to list 
      day_pat_per_envlist_unfilt[[i]]<-cur_mean_out
  }
  
  day_pat_per_env_df_unfilt<-bind_rows(day_pat_per_envlist_unfilt)
  
```


```{r visualise the outcome sc graph  , include=T, message=F, warning=F, echo=F, fig.width=10, fig.height=13}

plot<-ggplot(day_pat_per_env_df[day_pat_per_env_df$id=="fat_res",], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~env_id,  nrow=6)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        #coord_cartesian(xlim=c(0, 25))+
        labs(fill=" ")

      plot<-ggplotly(plot)
      plot%>% layout(legend = list(title=list(text='Model ID')))
      #plot_12
```

```{r energy proxies per specific environment  , include=T, message=F, warning=F, echo=F, fig.width=10, fig.height=13}
# Specify which environments are dead 
dead_environments<-c("1", "3", "4", "7")

list_plots<-list()
# loop 
for (i in 1:length(dead_environments)){
  env<-dead_environments[i]

plot_specificEnv<-ggplot(day_pat_per_env_df_unfilt[day_pat_per_env_df_unfilt$id=="stom_con" & day_pat_per_env_df_unfilt$env_id==env|day_pat_per_env_df_unfilt$id=="fat_res"& day_pat_per_env_df_unfilt$env_id==env|day_pat_per_env_df_unfilt$id=="fat_loss_r"& day_pat_per_env_df_unfilt$env_id==env,], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~id, scales='free_y', nrow=6)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        coord_cartesian(xlim=c(0, 25))+
        labs(fill=" ")+
        ylab(label="Energy proxy in gram or gram/2 hour")+
        xlab(label="Timestep in day")

      plot_specificEnv<-ggplotly(plot_specificEnv)
      plot_specificEnv%>% layout(legend = list(title=list(text='<b>Model ID<b>')))
      list_plots[[i]]<-plot_specificEnv
}

list_plots[[1]]
list_plots[[2]]
list_plots[[3]]
list_plots[[4]]
```
```{r again but facet wrap at once , include=T, message=F, warning=F, echo=F, fig.width=10, fig.height=13}
# Specify which environments are dead 
dead_environments<-c("1", "3", "4", "7")

dead_env_subset<-day_pat_per_env_df_unfilt%>%
  filter(id=="stom_con"|id=="fat_res"|id=="fat_loss_r")%>%
  filter(env_id=="1"|env_id=="3"|env_id=="4"|env_id=="7")

alive_env_subset<-day_pat_per_env_df_unfilt%>%
  filter(id=="stom_con"|id=="fat_res"|id=="fat_loss_r")%>%
  filter(env_id=="2"|env_id=="5"|env_id=="6"|env_id=="8"|env_id=="9"|env_id=="10"|env_id=="11"|env_id=="12")

# Now aggregate the alive environments 
alive_env_subset_agg<-alive_env_subset%>%
    group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="surv")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

dead_env_subset_agg<-dead_env_subset%>%
  group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="dead")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

dead_env_subset$env_id<-as.character(dead_env_subset$env_id)
dead_env_subset_agg$env_id<-as.character(dead_env_subset_agg$env_id)


#Together
dead_alive_subset<-rbind(dead_env_subset, alive_env_subset_agg, dead_env_subset_agg)

plot_specificEnv<-ggplot(dead_alive_subset[dead_alive_subset$env_id=="3"|dead_alive_subset$env_id=="surv"|dead_alive_subset$env_id=="dead",], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_grid(id ~ env_id, scales='free_y')+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        coord_cartesian(xlim=c(0, 25))+
        labs(fill=" ")+
        ylab(label="Energy proxy in gram or gram/2 hour")+
        xlab(label="Timestep in day")

      plot_specificEnv<-ggplotly(plot_specificEnv)
      plot_specificEnv%>% layout(legend = list(title=list(text='<b>Model ID<b>')))

```




### BEHAVIOURS 

#### Behaviours across all environments 
```{r plot all variables across enviornments in daily patterns BHES , include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}
# subset the data 

subset<-all_vars_day_pat_tot[all_vars_day_pat_tot$id_beh_label=="rest"|all_vars_day_pat_tot$id_beh_label=="hoard"|all_vars_day_pat_tot$id_beh_label=="eat"|all_vars_day_pat_tot$id_beh_label=="retrieve", ]
# take out the dir_hoarding for leftover hoarders and teh leftover hoarding for direct hoarders (otherwise the graphs go double because dir-hoarders will have 0 for leftover hoarding in each timestep, etc.)
subset<-subset%>%
  filter(!(line_id=="2" & id=="dir_hoard"))%>%
  filter(!(line_id=="3" & id=="eat_hoard"))%>%
  filter(!(line_id=="4" & id=="eat_hoard"))


plot<-ggplot(subset, aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~id_beh_label,nrow=2)+
        coord_cartesian(xlim=c(0, 25), ylim=c(0,1))+
        #ggtitle(label="Energy proxies- Daily patterns - Across all environments")+
        labs(y="Proportion of alive birds", x="Timestep within the Day", col="Model ID")+
        theme(plot.title=element_text( face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text( face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title = element_text(face='bold'))+
  scale_color_manual(values=colours)+
  labs(fill=" ")


p<-ggplotly(plot)
p%>% layout(legend = list(title=list(text='<b>Model ID<b>')))

```

#### behaviours for specific environments 

```{r plot all variables across enviornments in daily patterns BHES spec enviroment , include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}
# specify env 
env<-"3"
# subset 
subset<-day_pat_per_env_df[day_pat_per_env_df$id_beh_label=="rest"|day_pat_per_env_df$id_beh_label=="hoard"|day_pat_per_env_df$id_beh_label=="eat"|day_pat_per_env_df$id_beh_label=="retrieve", ]
# take out the dir_hoarding for leftover hoarders and teh leftover hoarding for direct hoarders (otherwise the graphs go double because dir-hoarders will have 0 for leftover hoarding in each timestep, etc.)
subset<-subset%>%
  filter(!(line_id=="2" & id=="dir_hoard"))%>%
  filter(!(line_id=="3" & id=="eat_hoard"))%>%
  filter(!(line_id=="4" & id=="eat_hoard"))%>%  
  filter(env_id==env)

# plot 
plot_specificEnv<-ggplot(subset, aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~id_beh_label, nrow=2)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        coord_cartesian(xlim=c(0, 25), ylim = c(0,1))+
        labs(fill=" ")+
        ylab(label="Proportion of alive birds")+
        xlab(label="Timestep in day")

      plot_specificEnv<-ggplotly(plot_specificEnv)
      plot_specificEnv%>% layout(legend = list(title=list(text='<b>Model ID<b>')))
      
```


So do a similar graph as for the dead-alive split with energy proxies, but now for the behaviours. 

```{r graphs for dead vs alive enviroments spit by behavoiur, include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}
# Specify which environments are dead 
dead_environments<-c("1", "3", "4", "7")

dead_env_subset_b<-day_pat_per_env_df_unfilt%>%
  filter(id=="eat"|id=="retrieve"|id=="dir_hoard"|id=="rest"|id=="eat_hoard")%>%
  filter(env_id=="1"|env_id=="3"|env_id=="4"|env_id=="7")

alive_env_subset_b<-day_pat_per_env_df_unfilt%>%
  filter(id=="eat"|id=="retrieve"|id=="dir_hoard"|id=="rest"|id=="eat_hoard")%>%
  filter(env_id=="2"|env_id=="5"|env_id=="6"|env_id=="8"|env_id=="9"|env_id=="10"|env_id=="11"|env_id=="12")

# Now aggregate the alive environments 
alive_env_subset_agg_b<-alive_env_subset_b%>%
    group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="surv")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

dead_env_subset_agg_b<-dead_env_subset_b%>%
  group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="dead")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

dead_env_subset_b$env_id<-as.character(dead_env_subset_b$env_id)
dead_env_subset_agg_b$env_id<-as.character(dead_env_subset_agg_b$env_id)


#Together
dead_alive_subset_b<-rbind(dead_env_subset_b, alive_env_subset_agg_b, dead_env_subset_agg_b)
# dead_alive_subset_b<-dead_alive_subset_b%>%
#   mutate(across(id, str_replace, "dir_hoard", "hoard"))%>%
#   mutate(across(id, str_replace, "eat_hoard", "hoard"))


plot_specificEnv_b<-ggplot(dead_alive_subset_b[dead_alive_subset_b$env_id=="3"|dead_alive_subset_b$env_id=="surv"|dead_alive_subset_b$env_id=="dead",], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_grid(id ~ env_id, scales="fixed")+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        coord_cartesian(xlim=c(0, 25))+
        labs(fill=" ")+
        ylab(label="Behaviour in proportion of alive birds")+
        xlab(label="Timestep in day")

      plot_specificEnv_b<-ggplotly(plot_specificEnv_b)
      plot_specificEnv_b%>% layout(legend = list(title=list(text='<b>Model ID<b>')))
```


## Bonanza - Poisson split 
Now, I need to split the surviving environments up by bonanza or poisson distribution. 

```{r graphs for  alive enviroments spit by poisson and bonanza, include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}
# Specify which environments are dead 
dead_environments<-c("1", "3", "4", "7")

p_env_subset_e<-day_pat_per_env_df_unfilt%>%
  filter(id=="stom_con"|id=="fat_res"|id=="fat_loss_r")%>%
  filter(env_id=="2"|env_id=="5"|env_id=="6"|env_id=="9"|env_id=="10") # Select the 'survival' enviornments with a Poisson distribution 

b_env_subset_e<-day_pat_per_env_df_unfilt%>%
  filter(id=="stom_con"|id=="fat_res"|id=="fat_loss_r")%>%
  filter(env_id=="8"|env_id=="11"|env_id=="12")                       # Select the 'survival' enviornments with a Bonanza distribution 


###### fix subset names and aggegates to shwo B and P distributions 

# Now aggregate the alive environments 
p_env_subset_agg_e<-p_env_subset_e%>%
    group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="Poisson")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

b_env_subset_agg_e<-b_env_subset_e%>%
  group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="Bonanza")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

b_env_subset_e$env_id<-as.character(b_env_subset_e$env_id)
b_env_subset_agg_e$env_id<-as.character(b_env_subset_agg_e$env_id)


#Together
p_b_subset_e<-rbind(b_env_subset_e, p_env_subset_agg_e, b_env_subset_agg_e)
# dead_alive_subset_b<-dead_alive_subset_b%>%
#   mutate(across(id, str_replace, "dir_hoard", "hoard"))%>%
#   mutate(across(id, str_replace, "eat_hoard", "hoard"))


plot_p_vs_b_e<-ggplot(p_b_subset_e[p_b_subset_e$env_id=="3"|p_b_subset_e$env_id=="Poisson"|p_b_subset_e$env_id=="Bonanza",], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_grid(id ~ env_id, scales="free_y")+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        coord_cartesian(xlim=c(0, 25))+
        labs(fill=" ")+
        ylab(label="Energy Proxy")+
        xlab(label="Timestep in day")

      plot_p_vs_b_e<-ggplotly(plot_p_vs_b_e)
      plot_p_vs_b_e%>% layout(legend = list(title=list(text='<b>Model ID<b>')))
```

I also want a graph that splits survival between bonanza and poisson 


```{r graphs for  alive enviroments spit by poisson and bonanza surviva, include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}

# add the temp info and regroup 
surviving_env<-total_all_models_surv%>%
  filter(env_id=="2"|env_id=="5"|env_id=="6"|env_id=="8"|env_id=="9"|env_id=="10"|env_id=="11"|env_id=="12")%>%
  group_by(timestep,leg_name, food_pred, line_id)%>%
  summarise(mean_val = mean(value, na.rm=T))


facet_order<-c("poisson", "bonanza")
surviving_env$food_pred <- factor(surviving_env$food_pred, levels = facet_order)

plot<-ggplot(surviving_env, aes(x=timestep, y=mean_val))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_wrap(.~food_pred,nrow=2)+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        ylab(label="Proportion of birds alive")

      plot<-ggplotly(plot)
plot %>% layout(legend=list(title=list(text='<b> Model ID</b>')))


```

Now split the good environments up by bonanza an dpoisson, but look into the behavioural outputs 

```{r graphs for  beh enviroments spit by poisson and bonanza, include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}
# Specify which environments are dead 
dead_environments<-c("1", "3", "4", "7")


p_env_subset_b<-day_pat_per_env_df_unfilt%>%
  filter(id=="eat"|id=="retrieve"|id=="dir_hoard"|id=="rest"|id=="eat_hoard")%>%
  filter(env_id=="2"|env_id=="5"|env_id=="6"|env_id=="9"|env_id=="10") # Select the 'survival' enviornments with a Poisson distribution 

b_env_subset_b<-day_pat_per_env_df_unfilt%>%
  filter(id=="eat"|id=="retrieve"|id=="dir_hoard"|id=="rest"|id=="eat_hoard")%>%
  filter(env_id=="8"|env_id=="11"|env_id=="12")                       # Select the 'survival' enviornments with a Bonanza distribution 


###### fix subset names and aggegates to shwo B and P distributions 

# Now aggregate the alive environments 
p_env_subset_agg_b<-p_env_subset_b%>%
    group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="Poisson")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

b_env_subset_agg_b<-b_env_subset_b%>%
  group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="Bonanza")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

b_env_subset_b$env_id<-as.character(b_env_subset_b$env_id)
b_env_subset_agg_b$env_id<-as.character(b_env_subset_agg_b$env_id)


#Together
p_b_subset_b<-rbind(b_env_subset_b, p_env_subset_agg_b, b_env_subset_agg_b)
# dead_alive_subset_b<-dead_alive_subset_b%>%
#   mutate(across(id, str_replace, "dir_hoard", "hoard"))%>%
#   mutate(across(id, str_replace, "eat_hoard", "hoard"))


plot_p_vs_b_b<-ggplot(p_b_subset_b[p_b_subset_b$env_id=="3"|p_b_subset_b$env_id=="Poisson"|p_b_subset_b$env_id=="Bonanza",], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_grid(id ~ env_id, scales="fixed")+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        coord_cartesian(xlim=c(0, 25))+
        labs(fill=" ")+
        ylab(label="Behaviour")+
        xlab(label="Timestep in day")

      plot_p_vs_b_b<-ggplotly(plot_p_vs_b_b)
      plot_p_vs_b_b%>% layout(legend = list(title=list(text='<b>Model ID<b>')))
```

Now create a large figure that combines the towo so I can easily refernce 

```{r graphs for  beh enviroments spit by poisson and bonanza combination, include=T, echo=F, warning=F, message=F, fig.width=11, fig.height=7}


p_env_subset_c<-day_pat_per_env_df_unfilt%>%
  filter(id=="eat"|id=="retrieve"|id=="rest"|id=="eat_hoard"|id=="stom_con"|id=="fat_res"|id=="fat_loss_r")%>%
  filter(env_id=="2"|env_id=="5"|env_id=="6"|env_id=="9"|env_id=="10") # Select the 'survival' enviornments with a Poisson distribution 

b_env_subset_c<-day_pat_per_env_df_unfilt%>%
  filter(id=="eat"|id=="retrieve"|id=="rest"|id=="eat_hoard"|id=="stom_con"|id=="fat_res"|id=="fat_loss_r")%>%
  filter(env_id=="8"|env_id=="11"|env_id=="12")                       # Select the 'survival' enviornments with a Bonanza distribution 


###### fix subset names and aggegates to shwo B and P distributions 

# Now aggregate the alive environments 
p_env_subset_agg_c<-p_env_subset_c%>%
    group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="Poisson")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

b_env_subset_agg_c<-b_env_subset_c%>%
  group_by(id, timestep_within_day, mod_id, line_id)%>%
    summarise(mean_new=mean(mean_new, na.rm=T))%>%
    mutate(env_id="Bonanza")%>%
    mutate(leg_name=case_when(
          endsWith(mod_id, "11") ~ "1.1: SC-non H", 
          endsWith(mod_id, "12") ~ "1.2: SC-left H", 
          endsWith(mod_id, "131") ~ "1.3.1: SC-dir Htop", 
          endsWith(mod_id, "132") ~ "1.3.2: SC-dir Rtop", 
          endsWith(mod_id, "21") ~ "2.1: FR-non H", 
          endsWith(mod_id, "22") ~ "2.2: FR-left H", 
          endsWith(mod_id, "231") ~ "2.3.1: FR-dir Htop", 
          endsWith(mod_id, "232") ~ "2.3.2: FR-dir Rtop",
          startsWith(mod_id, "31") ~ "3.1: FCR-non H", 
          startsWith(mod_id, "32") ~ "3.2: FCR-left H", 
          startsWith(mod_id, "331") ~ "3.3.1: FCR-dir Htop", 
          startsWith(mod_id, "332") ~ "3.3.2: FCR-dir Rtop",
        ))%>%
        mutate(id_beh_label=id)%>%
        mutate(across(id_beh_label, str_replace, "dir_hoard", "hoard"))%>%
        mutate(across(id_beh_label, str_replace, "eat_hoard", "hoard"))

b_env_subset_c$env_id<-as.character(b_env_subset_c$env_id)
b_env_subset_agg_c$env_id<-as.character(b_env_subset_agg_c$env_id)


#Together
p_b_subset_c<-rbind(b_env_subset_c, p_env_subset_agg_c, b_env_subset_agg_c)
# dead_alive_subset_b<-dead_alive_subset_b%>%
#   mutate(across(id, str_replace, "dir_hoard", "hoard"))%>%
#   mutate(across(id, str_replace, "eat_hoard", "hoard"))

facet_order<-c("stom_con", "fat_res", "fat_loss_r", "eat", "eat_hoard", "rest", "retrieve")
p_b_subset_c$id <- factor(p_b_subset_c$id, levels = facet_order)

# Specify scales for each facet
scale_types <- c("free_y", "free_y", "free_y", "fixed", "fixed", "fixed", "fixed")


plot_p_vs_b_c<-ggplot(p_b_subset_c[p_b_subset_c$env_id=="Poisson"|p_b_subset_c$env_id=="Bonanza",], aes(x=timestep_within_day, y=mean_new))+
        geom_line(aes( col=leg_name, linetype=line_id))+
        facet_grid(id ~ env_id, scales="fixed")+
        #ggtitle(label=paste(int_var, "- Variable per environment type" ))+
        theme(plot.title=element_text(face='bold'), 
              axis.title.x = element_text( face='bold' ), 
              axis.title.y=element_text(face='bold'), 
              strip.text=element_text(), 
              legend.text=element_text(), 
              legend.title=element_blank())+
        scale_color_manual(values=colours)+
        coord_cartesian(xlim=c(0, 25))+
        labs(fill=" ")+
        ylab(label="Value")+
        xlab(label="Timestep in day")

      plot_p_vs_b_c<-ggplotly(plot_p_vs_b_c)
      plot_p_vs_b_c%>% layout(legend = list(title=list(text='<b>Model ID<b>')))
```
